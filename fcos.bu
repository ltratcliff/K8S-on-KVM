variant: fcos
version: 1.5.0
storage:
  files:
    # CRI-O DNF module
    - path: /etc/dnf/modules.d/cri-o.module
      mode: 0644
      overwrite: true
      contents:
        inline: |
          [cri-o]
          name=cri-o
          stream=1.29
          profiles=
          state=enabled
    # YUM repository for kubeadm, kubelet and kubectl
    - path: /etc/yum.repos.d/kubernetes.repo
      mode: 0644
      overwrite: true
      contents:
        inline: |
          [kubernetes]
          name=Kubernetes
          baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/
          enabled=1
          gpgcheck=1
          gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key
    # configuring automatic loading of br_netfilter on startup
    - path: /etc/modules-load.d/br_netfilter.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          br_netfilter
          overlay
    # setting kernel parameters required by kubelet
    - path: /etc/sysctl.d/kubernetes.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          net.bridge.bridge-nf-call-iptables=1
          net.ipv4.ip_forward=1
passwd: # setting login credentials
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDOsz2ARpYszn5wbYlCH5xb4T1EFoPJsVP1Ftqo4Hc/VNFFafa51dAJyvcE/bCXHFEJtXatZ71RXAdra5cuG6mSGeD3OTlReTMuUEU13aE8iNGwUWq7mftWfmmqo7Lx2tjdcU3A4U/Tos8CoLX7v09YY3G3c1+QXycQtYnDi2ZUafbXyg63pGxuJdbIzW+ugzVvq1COKkPk0+aAfYeRL+OF4/D2SrJtpseloi5r2lGTcGwuJ5n1v0Qlc5eAuYj5rAxyucBs6PhYKckcC+J7EsC8qVPOMX85jkUak5Bk1NSS4Y/7YEMW/0eiEVwMhAkEjRUl56WWS9XwCk134tcRRyNomZyr+fmOR/Ft9szC8XwGoiVhmyHxioYrCwF71GvDhDRdsV+ZaY+mn400Ss3b814vUs/i6W53GhCXzzU0/HlZhmeMYD4EBjZcp3K5S0Y1Mz4NwsYtRFbZDyqkEPC39yrwzhf3rb8XWO+plLPsFPTSAaYJAY0JBIRQa4TqNn1VvcE= ltratcliff@rhel8
systemd:
  units:
    - name: python3-for-ansible.service
      enabled: true
      contents: |
          [Unit]
          Requires=network-online.target
          After=network-online.target
          Before=sshd.service
          [Service]
          Type=oneshot
          ExecCondition=/usr/bin/test ! -f /etc/python3-for-ansible.done
          ExecStart=/usr/bin/sed -i '/\\[updates\\]/,/^\\[/ s/^enabled=.*$/enabled=0/' /etc/yum.repos.d/fedora-updates.repo
          ExecStart=/usr/bin/rpm-ostree install python3 libselinux-python3
          ExecStart=/usr/bin/sed -i '/\\[updates\\]/,/^\\[/ s/^enabled=.*$/enabled=1/' /etc/yum.repos.d/fedora-updates.repo
          ExecStart=/usr/bin/sed -i '/^\\[updates\\]/a exclude=libxcrypt-compat* mpdecimal* python-pip-wheel* python-setuptools-wheel* python-unversioned-command* python3* python3-libs* python3-selinux*' /etc/yum.repos.d/fedora-updates.repo
          ExecStartPost=/usr/bin/touch /etc/python3-for-ansible.done
          ExecStartPost=/usr/sbin/shutdown -r now
          [Install]
          WantedBy=multi-user.target